angular.module("azureBlobUpload",[]).factory("azureBlob",["$http",function(e){"use strict";var r,t,o,n,l,s,a,i;return a=function(r){var t,o;return o=l(r),t=new FileReader,t.onloadend=function(r){var n,l;return r.target.readyState!==FileReader.DONE||o.cancelled?void 0:(l=o.fileUrl+"&comp=block&blockid="+o.blockIds[o.blockIds.length-1],n=new Uint8Array(r.target.result),e.put(l,n,{headers:{"x-ms-blob-type":"BlockBlob","Content-Type":o.file.type},transformRequest:[]}).success(function(e,r,l,s){var a;return o.bytesUploaded+=n.length,a=(parseFloat(o.bytesUploaded)/parseFloat(o.file.size)*100).toFixed(2),o.progress?(o.progress(a,e,r,l,s),i(t,o)):void 0}).error(function(e,r,t,n){return o.error?o.error(e,r,t,n):void 0}))},i(t,o),{cancel:function(){return o.cancelled=!0}}},r=32768,l=function(e){var t,o,n,l,s;return t=e.blockSize?e.blockSize:r,l=t,s=1,o=e.file,n=o.size,t>n&&(l=n),s=n%l===0?n/l:parseInt(n/l,10)+1,{maxBlockSize:l,numberOfBlocks:s,totalBytesRemaining:n,currentFilePointer:0,blockIds:new Array,blockIdPrefix:"block-",bytesUploaded:0,submitUri:null,file:o,baseUrl:e.baseUrl,sasToken:e.sasToken,fileUrl:e.baseUrl+e.sasToken,progress:e.progress,complete:e.complete,error:e.error,cancelled:!1}},i=function(e,r){var o,n;if(!r.cancelled){if(!(r.totalBytesRemaining>0))return t(r);if(n=r.file.slice(r.currentFilePointer,r.currentFilePointer+r.maxBlockSize),o=r.blockIdPrefix+s(r.blockIds.length,6),r.blockIds.push(btoa(o)),e.readAsArrayBuffer(n),r.currentFilePointer+=r.maxBlockSize,r.totalBytesRemaining-=r.maxBlockSize,r.totalBytesRemaining<r.maxBlockSize)return r.maxBlockSize=r.totalBytesRemaining}},t=function(r){var t,o,n,l,s,a;for(a=r.fileUrl+"&comp=blocklist",s='<?xml version="1.0" encoding="utf-8"?><BlockList>',l=r.blockIds,o=0,n=l.length;n>o;o++)t=l[o],s+="<Latest>"+t+"</Latest>";return s+="</BlockList>",e.put(a,s,{headers:{"x-ms-blob-content-type":r.file.type}}).success(function(e,t,o,n){return r.complete?r.complete(e,t,o,n):void 0}).error(function(e,t,o,n){return r.error?r.error(e,t,o,n):void 0})},s=function(e,r){var t;for(t=""+e;t.length<r;)t="0"+t;return t},o=function(e){var r,t;return t=n(e),r=new XMLHttpRequest,r.addEventListener("progress",function(e){return t.progress((100*e.loaded/e.total).toFixed(0))}),r.addEventListener("load",function(e){return t.complete(e.target.response,e)}),r.addEventListener("error",function(e){return t.error(e)}),r.addEventListener("abort",function(e){return t.cancelled(e)}),r.responseType="blob",r.open("get",t.fileUrl),r.send(),{cancel:function(){return r.abort()}}},n=function(e){return{baseUrl:e.baseUrl,sasToken:e.sasToken,fileUrl:e.baseUrl+e.sasToken,progress:e.progress,complete:e.complete,error:e.error}},{upload:a,download:o}}]);